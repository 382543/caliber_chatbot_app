# ============================================================================
# Caliber Health - Full-Stack Deployment Configuration for Render.com
# ============================================================================
#
# PROJECT STRUCTURE:
# ------------------
# /
# â”œâ”€â”€ main.py                    â† Entry point (launches everything)
# â”œâ”€â”€ requirements.txt           â† Python dependencies
# â”œâ”€â”€ render.yaml               â† This file (deployment config)
# â”‚
# â”œâ”€â”€ backend/                  â† FastAPI Backend Service
# â”‚   â”œâ”€â”€ app.py               â† FastAPI routes + ML model + Gemini chatbot
# â”‚   â””â”€â”€ food_classification_model.keras  â† 77MB trained model
# â”‚
# â””â”€â”€ frontend/                â† React Frontend
#     â”œâ”€â”€ src/                 â† React source code
#     â”œâ”€â”€ dist/                â† Built frontend (auto-generated)
#     â””â”€â”€ package.json         â† Node.js dependencies
#
# WHAT RUNS WHERE:
# ----------------
# â€¢ main.py          â†’ Application launcher (imports backend/app.py)
# â€¢ backend/app.py   â†’ FastAPI server with:
#                       - POST /predict â†’ Food classification ML model
#                       - POST /api/chat â†’ Gemini AI health chatbot
#                       - GET /health â†’ Health check endpoint
# â€¢ React Frontend   â†’ Built and served as static files from /dist
#
# DEPLOYMENT FLOW:
# ----------------
# 1. Build Phase: Install Python + Node deps, build React app
# 2. Start Phase: Run main.py â†’ imports backend/app.py â†’ serves frontend
# 3. Result: Single web service on https://your-app.onrender.com
#
# ============================================================================

services:
  - type: web
    name: caliber-health-app
    runtime: python
    
    # ========== BUILD COMMAND ==========
    # Installs all dependencies and builds the React frontend
    buildCommand: |
      echo "ğŸ“¦ Installing Python dependencies..."
      pip install --upgrade pip
      pip install -r requirements.txt
      
      echo "ğŸ“¦ Installing Node.js dependencies and building React frontend..."
      cd frontend
      npm install
      npm run build
      cd ..
      
      echo "âœ… Build completed successfully!"
    
    # ========== START COMMAND ==========
    # Runs main.py which launches backend/app.py (FastAPI + ML + Chatbot)
    startCommand: python main.py
    
    # ========== ENVIRONMENT VARIABLES ==========
    envVars:
      - key: PYTHON_VERSION
        value: 3.11.0
      
      - key: NODE_VERSION
        value: 20.10.0
      
      # âš ï¸ IMPORTANT: Add this in Render Dashboard (Environment tab)
      # Get your key from: https://aistudio.google.com/app/apikey
      - key: GEMINI_API_KEY
        sync: false  # Set manually in dashboard for security
      
      - key: RENDER
        value: "true"
    
    # ========== CONFIGURATION ==========
    plan: starter  # Recommended: Starter ($7/mo) - Free tier may timeout with ML model
    healthCheckPath: /health
    autoDeploy: true  # Auto-deploy on git push
    region: oregon    # Choose closest to your users (oregon, frankfurt, singapore, etc.)

# ============================================================================
# DEPLOYMENT CHECKLIST:
# ============================================================================
# [ ] Push code to GitHub/GitLab
# [ ] Connect repository in Render.com dashboard
# [ ] Add GEMINI_API_KEY in Environment tab
# [ ] Deploy and wait ~5-10 minutes for build
# [ ] Access your app at https://caliber-health-app.onrender.com
# ============================================================================
